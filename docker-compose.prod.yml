# Housarr Docker Compose - Production Overlay
# Usage: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d

services:
  nginx:
    volumes:
      - ./docker/nginx/production.conf:/etc/nginx/conf.d/default.conf:ro
    # Don't expose ports directly in production - use reverse proxy
    ports: []
    expose:
      - "80"
    read_only: true
    tmpfs:
      - /var/cache/nginx
      - /var/run
    security_opt:
      - no-new-privileges:true

  php:
    build:
      target: production
    environment:
      APP_ENV: production
      APP_DEBUG: "false"
    read_only: true
    tmpfs:
      - /tmp
    volumes:
      - ./backend:/var/www/html:cached,ro
      - ./backend/storage:/var/www/html/storage:cached
      - ./backend/bootstrap/cache:/var/www/html/bootstrap/cache:cached
      - ./data:/var/www/html/storage/app
    security_opt:
      - no-new-privileges:true

  mysql:
    # No port exposure in production
    ports: []
    expose:
      - "3306"

  redis:
    # No port exposure in production
    ports: []
    expose:
      - "6379"
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru --requirepass ${REDIS_PASSWORD:?REDIS_PASSWORD is required}

  scheduler:
    build:
      target: production
    environment:
      APP_ENV: production
    read_only: true
    tmpfs:
      - /tmp
    volumes:
      - ./backend:/var/www/html:cached,ro
      - ./backend/storage:/var/www/html/storage:cached
      - ./data:/var/www/html/storage/app
    security_opt:
      - no-new-privileges:true

  worker:
    build:
      target: production
    environment:
      APP_ENV: production
    read_only: true
    tmpfs:
      - /tmp
    volumes:
      - ./backend:/var/www/html:cached,ro
      - ./backend/storage:/var/www/html/storage:cached
      - ./data:/var/www/html/storage/app
    security_opt:
      - no-new-privileges:true
    # Scale workers in production
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.25'

  # Remove node from production - frontend should be pre-built
  node:
    profiles:
      - donotstart
